---
sidebar_position: 1
---
# Lab 0：实验环境配置

## 实验环境

处理器：`Apple M1 MAX`

操作系统：`macOS Monterey 12.0.1`

内存：`32 GB`

> 实践证明，最适合移植任务的实验环境仍然是 `Linux` 操作系统；如果是 `mac` 用户，也尽量选择 `intel` 处理器版本的机器。由于 `M1` 处理器的特殊性，笔者在初期编译工具链时碰到了很大麻烦。

## 交叉编译器

由于我们需要使用 `RISC-V` 指令集撰写内核，而本机的工具链面向 `arm` 指令集，因此只有通过交叉编译器，我们才能够在本机上编译 `RISC-V` 代码，工具链地址为：[riscv-gnu-toolchain][https://github.com/riscv-collab/riscv-gnu-toolchain]。

通过上述地址，可以获取我们所需要的工具链源码，如果是 `linux` 或者 `intel` 版本的 `macOS` 用户，可以直接按照 `README` 中的提示自行编译。但笔者机器是 `M1` 版本，在编译过程中发现部分依赖`可能`没有适配 `M1` 架构的处理器，导致即使安装了依赖，也始终编译失败，在各类论坛上搜索无果。但令人诧异的是，笔者最终直接下载了某个偏僻企业网站（后来翻阅浏览记录没有再次找到该网站）上提供的 `mac intel` 版本的工具链`可执行文件`，它竟然可以在笔者机器上直接运行，按理说这应该是不可能的，毕竟架构完全不同。

> 在书写这篇报告的时候，笔者重新去搜集了这方面的资料，发现原来 `Apple` 公司提供了一个叫做 `Rosetta 2` 的转换层，它可以使得我们在 `Apple Silicon Macs` 上使用基于 `intel` 的应用程序，这就解释了为什么笔者当初可以直接使用针对 `mac intel` 的工具链可执行文件。这算是解答了笔者很久以来的一个困惑，不过也说明最好不要使用 `M1` 版本机器去完成移植任务，可能会遇到自己难以解决的问题。

另外需要注意的是，针对不同架构的工具链可能支持的功能不完全一样，比如 `MOS` 中使用的 `mips-4KC` 版本的 `gcc` 可以编译在 `.S文件` 中引用 `C语言头文件`的代码，但笔者下载的 `RISC-V` 版本的 `gcc` 似乎是不支持该功能。

## 硬件模拟器

在本次移植中，笔者选择在 `qemu` 模拟的硬件上进行移植，安装命令如下：

```
brew install qemu
```

笔者下载的版本为 `6.2.0_1`，使用的模拟器为 `qemu-system-riscv64`。

如果不能使用 `homebrew` 下载 `qemu`，可以在[qemu][https://github.com/qemu/qemu]处自行 `clone` 并编译源码，`qemu` 版本最好高于 `5.0.0`。
