<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-cpu-design-pattern/Implement CPU by software oriented approach">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Implement CPU by Software Oriented Approach | yufoo1&#x27;s Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://yufoo1.github.io/docs/cpu-design-pattern/Implement CPU by software oriented approach"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Implement CPU by Software Oriented Approach | yufoo1&#x27;s Site"><meta data-rh="true" name="description" content="Considering to implement highly configurable CPU, we should use a very software oriented approach , in which there are few things that are fixed. This article borrows a lot from VexRiscv, a RISC-V CPU written in SpinalHDL , source code is here. In VexRiscv, nearly everything is plugin based, which means we can simply expand it or shrink it.  Besides, there is an automatic tool allowing plugins to insert data at a given stage and other plugins to read it in another stage. There is also a service system which provides a very dynamic framework to handle exception."><meta data-rh="true" property="og:description" content="Considering to implement highly configurable CPU, we should use a very software oriented approach , in which there are few things that are fixed. This article borrows a lot from VexRiscv, a RISC-V CPU written in SpinalHDL , source code is here. In VexRiscv, nearly everything is plugin based, which means we can simply expand it or shrink it.  Besides, there is an automatic tool allowing plugins to insert data at a given stage and other plugins to read it in another stage. There is also a service system which provides a very dynamic framework to handle exception."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yufoo1.github.io/docs/cpu-design-pattern/Implement CPU by software oriented approach"><link data-rh="true" rel="alternate" href="https://yufoo1.github.io/docs/cpu-design-pattern/Implement CPU by software oriented approach" hreflang="en"><link data-rh="true" rel="alternate" href="https://yufoo1.github.io/docs/cpu-design-pattern/Implement CPU by software oriented approach" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="yufoo1&#39;s Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="yufoo1&#39;s Site Atom Feed">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.793b1a00.css">
<link rel="preload" href="/assets/js/runtime~main.28426300.js" as="script">
<link rel="preload" href="/assets/js/main.681d44e8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">yufoo1&#x27;s Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Tutorial</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yufoo1" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/超标量处理器">超标量处理器</a><button aria-label="Toggle the collapsible sidebar category &#x27;超标量处理器&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/python-网络爬虫">Python 网络爬虫</a><button aria-label="Toggle the collapsible sidebar category &#x27;Python 网络爬虫&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/java-虚拟机">Java 虚拟机</a><button aria-label="Toggle the collapsible sidebar category &#x27;Java 虚拟机&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/机器学习">机器学习</a><button aria-label="Toggle the collapsible sidebar category &#x27;机器学习&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/webapp-development">Web/App Development</a><button aria-label="Toggle the collapsible sidebar category &#x27;Web/App Development&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/risc-v-操作系统移植">Risc-V 操作系统移植</a><button aria-label="Toggle the collapsible sidebar category &#x27;Risc-V 操作系统移植&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/design-pattern-in-cpu">Design Pattern in CPU</a><button aria-label="Toggle the collapsible sidebar category &#x27;Design Pattern in CPU&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/cpu-design-pattern/Implement CPU by software oriented approach">Implement CPU by Software Oriented Approach</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/git">Git</a><button aria-label="Toggle the collapsible sidebar category &#x27;Git&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/nginx">Nginx</a><button aria-label="Toggle the collapsible sidebar category &#x27;Nginx&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/haskell">Haskell</a><button aria-label="Toggle the collapsible sidebar category &#x27;Haskell&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/design-pattern-in-cpu"><span itemprop="name">Design Pattern in CPU</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Implement CPU by Software Oriented Approach</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Implement CPU by Software Oriented Approach</h1><p>Considering to implement highly configurable CPU, we should use a very <code>software oriented approach</code> , in which there are few things that are fixed. This article borrows a lot from VexRiscv, a RISC-V CPU written in <code>SpinalHDL</code> , <a href="https://github.com/SpinalHDL/VexRiscv" target="_blank" rel="noopener noreferrer">source code is here</a>. In VexRiscv, nearly everything is plugin based, which means we can simply expand it or shrink it.  Besides, there is an automatic tool allowing plugins to insert data at a given stage and other plugins to read it in another stage. There is also a service system which provides a very dynamic framework to handle exception.</p><p>I will try to understand this software oriented design approach and how VexRiscv use it, this article will record some thoughts of myself. Then, I will design my own CPU in <code>Chisel</code> through this unique approach.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="simple-introduction-of-vexriscv-architecture">Simple Introduction of VexRiscv Architecture<a class="hash-link" href="#simple-introduction-of-vexriscv-architecture" title="Direct link to heading">​</a></h2><p>VexRiscv is implemented via a 5 stage in-order pipeline and it&#x27;s function can be extended through lots of optional and complementary plugins. The Extensibility of VexRiscv is so superior that we can turn on or turn off parts of this CPU directly through it&#x27;s well-designed plugin system and add new functionalities or instructions without modifying any source of this CPU.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gen-smallest">Gen Smallest<a class="hash-link" href="#gen-smallest" title="Direct link to heading">​</a></h3><p>When we choose to generate VexRiscv in a smallest configuration, it firstly define a method which will return a instance of CPU. This method has only one parameter that representing the configuration we expected. The configuration is described through an object, which apply method need a list of plugins and we can also configure plugin before pushing it into that plugin list. By the way, the default option of VexRiscv is with memory stage and write back stage and <code>GenSmallest</code> needs:</p><ul><li>IBusSimplePlugin: implements the CPU frontend via a very simple and neutral memory interface out of CPU.</li><li>DBusSimplePlugin: implements the load and store instructions via a simple memory bus out of CPU.</li><li>CsrPlugin: implements most of the Machine mode and a few of the User mode registers.</li><li>DecodeSimplePlugin: provides instruction decoding capabilities.</li><li>RegFilePlugin: implements the register file.</li><li>IntAluPlugin: implements all compute instructions in the execute stage. The source values are from the outputs of SrcPlugin, which will be described next.</li><li>SrcPlugin: muxes different input values to produce values of the source registers.</li><li>LightShifterPlugin: implements shifter instructions in one cycle by using an iterative shifter register.</li><li>HazardSimplePlugin: checks the pipeline instruction dependencies, bypass the instruction results of stop the instruction in the decoding stage if necessary.</li><li>BranchPlugin: implements branch and jump instructions with primitives used  by the CPU frontend to implement branch prediction.</li><li>YamlPlugin: offers a service to other plugins to generate a Yaml file describing the CPU configuration.</li></ul><p>Take <code>RegFilePlugin</code> as an example. RegFilePlugin has 8 configuration parameters and in <code>GenSmallest</code> only 2 of them are configured, <code>regFileReadyKind</code> is configured to <code>Sync</code> and <code>zeroBoot</code> is configured to <code>false</code>, other parameters use default configuration. Every plugin extend the trait <code>Plugin and override two important methods</code>, <code>setup(pipeline: T)</code> and <code>build(pipeline: T)</code>.</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> setup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pipeline</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> VexRiscv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Unit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">pipeline</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">config</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token plain">_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> decoderService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pipeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classOf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">DecoderService</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decoderService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RS1_USE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decoderService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RS2_USE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decoderService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">REGFILE_WRITE_VALID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the code above, pipeline is instance of VexRiscv, which extends trait <code>Pipeline</code>. pipeline has a method <code>service</code>, which can filter the class extended it&#x27;s parameter, a trait, or filter the same class and superclass. In the example above, DecoderService is a trait and  DecodeSimplePlugin extends it. Therefore, we can get the instance of DecodeSimplePlugin if we call pipeline.service<!-- -->[<!-- -->T](clazz: Class<!-- -->[T]<!-- -->). Then, this example calls decoderService.addDefault(key: Stageable<!-- -->[_ &lt;: BaseType]<!-- -->, value: Any). The method addDefault is overrided in DecodeSimplePlugin and it can add configuration into DecodeSimplePlugin, which can be known by other plugin.</p><p>The method <code>build</code> of RegFilePlugin is complicated and we take the build of <code>IntAluPlugin</code> as another example.</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pipeline</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> VexRiscv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Unit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">pipeline</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token plain">_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">pipeline</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">config</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token plain">_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    execute plug </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> Area</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">execute</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token plain">_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> bitwise </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ALU_BITWISE_CTRL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mux</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AluBitwiseCtrlEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AND  </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SRC1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SRC2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AluBitwiseCtrlEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OR   </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SRC1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SRC2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AluBitwiseCtrlEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">XOR  </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SRC1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SRC2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// mux results</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">REGFILE_WRITE_DATA</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ALU_CTRL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mux</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AluCtrlEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BITWISE  </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> bitwise</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AluCtrlEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SLT_SLTU </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SRC_LESS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">asBits</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> bit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AluCtrlEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ADD_SUB  </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SRC_ADD_SUB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>input</code> is a method of <code>Stage</code>, which has one parameter <code>key: Stageable[T]</code>. Through <code>key</code>, we can get the corresponding input value of this stage. Here is the implementation of <code>input</code>.</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> inputs   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mutable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LinkedHashMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Stageable</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">Data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> outsideCondScope</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">that </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> T </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get the head of the current component symboles tree (AST in other words)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Component</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dslBody</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Now all access to the SpinalHDL API will be append to it (instead of the current context)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> ctx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Empty the symbole tree (but keep a reference to the old content)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> swapContext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">swap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Execute the block of code (will be added to the recently empty body)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> that</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Restore the original context in which this function was called</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">restore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// append the original symboles tree to the modified body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    swapContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">appendBack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// return the value returned by that</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Stageable</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> T </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrElseUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">asInstanceOf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Stageable</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">outsideCondScope</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">inputDefault </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      inputsDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">asInstanceOf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Stageable</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inputDefault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      input </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inputDefault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setPartialName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">asInstanceOf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If given key is already in the hash map, <code>getOrElseUpdate</code> will return associated value. Otherwise, it will compute value from given expression and return, meanwhile store the nonexistent key into hash map with the computed value.</p><p>Let&#x27;s go back to the <code>build</code> method. When we get the result through <code>IntAluPlugin</code>, we then call <code>insert</code> method to insert it into current stage.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/cpu-design-pattern/Implement CPU by software oriented approach.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/design-pattern-in-cpu"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Design Pattern in CPU</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/git"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Git</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#simple-introduction-of-vexriscv-architecture" class="table-of-contents__link toc-highlight">Simple Introduction of VexRiscv Architecture</a><ul><li><a href="#gen-smallest" class="table-of-contents__link toc-highlight">Gen Smallest</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 yufoo1's Site.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.28426300.js"></script>
<script src="/assets/js/main.681d44e8.js"></script>
</body>
</html>