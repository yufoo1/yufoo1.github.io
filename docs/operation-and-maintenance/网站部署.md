---
sidebar_position: 1
---
# 网站部署

本文以前端 `Vue` 、后端 `Gin`、数据库 `MySQL` 与 `MongoDB` 为例进行说明，其他框架与数据库部署方式类似。

## 启动MySQL数据库

* 获取服务器，重置实例密码。笔者使用的是阿里云服务器， `ubuntu 22.04` 系统
* `ssh` 远程连接服务器，使用如下命令下载 `docker`

```shell
curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
```

* 拉取 `mysql` 镜像

```shell
docker pull mysql
```

* ` docker` 启动 `mysql` 并开启远程服务

```shell
# docker运行mysql
docker run --name 此处为容器名 -d -p 此处为宿主机端口:此处为容器端口 -e MYSQL_ROOT_PASSWORD=此处为您的密码 mysql
# 查看mysql是否启动及其相应CONTAINER ID
docker ps
# 进入mysql容器
docker exec -it 此处为mysql的CONTAINER ID /bin/bash
# 登录 mysql
mysql -u root -p
# 输入密码
# 切换database
use 此处为您的database名
# 查询数据库有哪些用户
select user,host from mysql.user; # 如果存在user：root，host：%，说明数据库可以被远程连接
```

* 外机远程连接 `docker` 中的数据库

> 笔者使用的是 `DataGrip` 。

## 启动MongoDB数据库

```shell
mongo # 进入mongo shell
use admin
db.createUser({user:"root",pwd:"root",roles:[  {role:"root", db:"admin" } ]})

db.auth("root","root")

use dedeket
db.createUser({user:"此处为您的用户名", pwd:"此处为您的密码",roles:[{role:"readWrite",db:"此处为您的数据库名"},"readWrite"]})
db.createCollection("此处为您的集合名")

# connection() error occurred during connection handshake的问题参考https://stackoverflow.com/questions/66719861/unable-to-authenticate-with-mongodb-golang-driver
```

## 启动后端

* 本地 `scp` 上传后端代码，项目目录使用 `go run ./main.go` 命令
* 如因网络原因无法下载依赖，可在本地通过 `scp` 上传后端项目全部依赖，上传目录为服务器的 `/root/go/pkg/mod`
* 交叉编译后端项目

```shell
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build .
```

* 编写 `Dockerfile`

```dockerfile
# 拉取镜像
FROM ubuntu:22.04
# 创建目录，可忽略
RUN mkdir /build
# 设置工作目录
WORKDIR /build
# 将项目复制到docker中对应目录
COPY 此处为您项目打包后的名字 /build/此处为您项目名
# 暴露端口
EXPOSE 此处为您后端监听的端口
# docker启动后直接运行项目
ENTRYPOINT ["./此处为您项目名"]
```

* 生成 `docker` 镜像

```shell
docker build -t 此处为您docker的镜像名 .
```

* 启动 `docker`

```shell
docker run --name 此处为您的容器名 -d -p 此处为宿主机端口:此处为您希望映射到的docker端口 此处为您docker的镜像名
```

* 查看是否成功部署

```shell
# 查看容器是否已启动
docker ps
```

## 启动前端

``` shell
# 项目打包
npm run build

# 将得到的 dist 文件夹放至某一路径

# 安装 nginx
sudo apt-get install nginx

# 修改 nginx 配置文件
vim /etc/nginx/nginx.conf

# 具体修改如下
server {
                listen 此处为您希望代理的端口;
                listen 80;
                server_name localhost;
                root 此处为 dist 文件夹的路径;

                location / {
                }

        }

# 启动 nginx 服务
nginx

# 重启 nginx 服务
nginx -s reload
```

## 问题总结

### docker 拉取 mysql 镜像失败

使用 `docker pull mysql` 拉取镜像时产生如下报错

```
Error response from daemon: Head "https://registry-1.docker.io/v2/library/mysql/manifests/latest": net/http: TLS handshake timeout
```

可通过配置 `daemon.json` 文件解决，具体如下：

```shell
sudo vim /etc/docker/daemon.json

# daemon.json
{
 "registry-mirrors":["https://6kx4zyno.mirror.aliyuncs.com"]
}

systemctl daemon-reload
systemctl restart docker
```

然后重新拉取即可。

### 关代理

外机 `ping` 不通服务器的公有 `IP` 可能是因为外机代理未关。

### 端口无法放行

阿里云有其自己的端口开放策略，默认只放行 `22` 和 `3389` 如需放行某些端口，需要到阿里云平台设置相应服务器的安全组，否则仅通过配置服务器无法真正放行端口。

### 请求成功发出，但 response 为空

笔者发现后端用于连接数据库的信息错误，修改后重新启动后端服务即可。

### 宿主机api服务正常，docker中api服务不正常

笔者使用了阿里云的短信服务 `api` ，当后端运行于宿主机时，可以正常调用 `api` 发送验证码；当后端运行于 `docker` 中时，可以知道 `docker` 接受到了请求，但是不能正常调用 `api` ，该问题暂未解决。

